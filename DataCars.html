<div class="row g-3 mt-2">
  <div class="col-12 col-lg-8 col-xl-8">
    <div class="card border-0 shadow-sm mb-2">
      <div class="card-body rounded-4">
        <ul class="nav nav-underline nav-fill">
          <li class="nav-item">
            <a class="nav-link custom-nav-link" href="#" style="color: var(--box1);font-size: 14px;"
              onclick="filterCarsStatus('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')">‚åõ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
              <span class="badge set-button" id="countsStatusCarsA">0</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link custom-nav-link" href="#" style="color: var(--box4);font-size: 14px;"
              onclick="filterCarsStatus('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
              <span class="badge del-button" id="countsStatusCarsD">0</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link custom-nav-link" href="#" style="color: var(--box4);font-size: 14px;"
              onclick="filterCarsStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              <span class="badge del-button" id="countsStatusCarsB">0</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link custom-nav-link" href="#" style="color: var(--box2);font-size: 14px;"
              onclick="filterCarsStatus('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
              <span class="badge upload-button" id="countsStatusCarsC">0</span></a>
          </li>
        </ul>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-4 mb-2 mb-md-0">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤</div>
          <div class="col-12 col-md-8 d-flex flex-wrap justify-content-md-end">
            <input type="search" class="form-control float-sm-end me-2 mb-2 mb-md-0" style="width: auto;" id="searchCars" placeholder="üîç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." oninput="filterCars()">
          </div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th scope="col" class="text-center">#</th>
                <th scope="col" class="text-center">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ</th>
                <th scope="col" class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</th>
                <th scope="col" class="text-center">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ</th>
                <th scope="col" class="text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th scope="col" class="text-center">‡πÉ‡∏ö‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</th>
                <th scope="col" class="text-center">Action</th>
              </tr>
            </thead>
            <tbody id="tableDataCars"></tbody>
          </table>
        </div>
        <div class="row mt-1">
          <div class="col-12 col-md-6 mb-2 mb-md-0 align-items-center" id="paginationCarsInfo"></div>
          <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
            <div id="paginationCars" class="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4 col-xl-4">
    <div class="card border-0 shadow-sm mb-2">
      <div class="card-header bg-white">
        <div class="row">
          <div class="col-12 col-md-12 mb-2 mb-md-0">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ‡∏ä‡πà‡∏≤</div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div id="calendarCars"></div>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="row g-3">
          <div class="col-12 col-md-12 mb-2 mb-md-0">üíπ ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤</div>
        </div>
      </div>
      <div class="card-body rounded-4">
        <div id="chartCars" style="width: 100%; height: 350px;"></div>
        <div id="carsSummary"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const parseDate = (dateString) => {
  return new Date(dateString);
};

let dataCars = [];
let filteredCars = [];
let selectedCars = {};
let filterPageCars = '';
let currentCars = 1;
let itemsPerCars = 10;

const insertDataCars = (initialStatus = '') => {
  google.script.run.withSuccessHandler((data) => {
    dataCars = data;
    filterPageCars = initialStatus;
    filteredCars = filterPageCars ? data.filter(item => item[1] === filterPageCars) : data;
    currentCars = 1;
    renderCars(filteredCars);
    renderPageCars(filteredCars.length);
    countsStatusCars(data);
  }).getDataCar();
}

const renderCars = (res) => {
  const table = document.getElementById('tableDataCars');
  table.innerHTML = '';

  res.sort((a, b) => parseDate(b[15]) - parseDate(a[15]));

  const userRole1 = localStorage.getItem('fullname') || '';
  const userRole2 = localStorage.getItem('level') || '';

  const startIndex = (currentCars - 1) * itemsPerCars;
  const endIndex = startIndex + itemsPerCars;
  const ca = res.slice(startIndex, endIndex);

  const startRow = startIndex + 1;
  const endRow = startIndex + ca.length;
  const totalRows = res.length;

  document.getElementById('paginationCarsInfo').innerText = `‡πÅ‡∏™‡∏î‡∏á ${startRow} ‡∏ñ‡∏∂‡∏á ${endRow} ‡∏à‡∏≤‡∏Å ${totalRows} ‡πÅ‡∏ñ‡∏ß`;

  if (ca.length === 0) {
    const row = table.insertRow();
    row.innerHTML = `<td colspan='8' class='fw-bold text-danger text-center p-4'><i class='fa-solid fa-circle-info text-danger'></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! üòì</td>`;
    return;
  }

  ca.forEach((rowIndex, index) => {
    let status = rowIndex[1];
    let actionStatus;
    let pdfLink = rowIndex[27];
    let pdfButton;
    if (userRole2 === 'SuperAdmin' || userRole2 === 'Admin' || userRole1 === rowIndex[4]) {
        if (pdfLink) {
          pdfButton = `<a href="${pdfLink}" target="_blank" class="btn btn-sm me-2 set-button"><i class="fa-solid fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>`;
        } else {
          pdfButton = `<button class="btn btn-sm me-2 del-button">‚ùå ‡πÑ‡∏ü‡∏•‡πå</button>`;
        }
      } else {
        pdfButton = `<button class="btn btn-sm me-2 del-button" onclick="createToast('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 3)">‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>`;
      }
    switch (status) {
      case "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö":
        status = `<span style="color: var(--box1);font-size: 14px;">‚åõ ${rowIndex[1]}</span>`;
        actionStatus = `<button type='button' class='btn btn-sm me-2 upload-button' onclick='showModalCars("${rowIndex[0]}");'>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>`;
        break;
      case "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥":
        status = `<span style="color: var(--box2);font-size: 14px;">‚úÖ ${rowIndex[1]}</span>`;
        actionStatus = `<button type='button' class='btn btn-sm me-2 upload-button' onclick='showModalCars("${rowIndex[0]}");'>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>`;
        break;
      case "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å":
        status = `<span style="color: var(--box4);font-size: 14px;">‚ùå ${rowIndex[1]}</span>`;
        actionStatus = `<button type='button' class='btn btn-sm me-2 upload-button' onclick='showModalCars("${rowIndex[0]}");'>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>`;
        break;
      default:
        status = `<span style="color: var(--box4);font-size: 14px;">‚ùå ${rowIndex[1]}</span>`;
        actionStatus = `<button type='button' class='btn btn-sm me-2 upload-button' onclick='showModalCars("${rowIndex[0]}");'>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>`;
    }

    let user = dataUsers.find(user => user[0] === rowIndex[3]);
    let userImage = user ? user[7] : 'https://e1.pngegg.com/pngimages/98/854/png-clipart-voiture-location-de-voitures-location-logo-tour-operateur-tourisme-vacances-client.png';

    let car = dataShowCars.find(car => car[0] === rowIndex[11]);
    let carImage = car ? car[8] : 'https://e1.pngegg.com/pngimages/98/854/png-clipart-voiture-location-de-voitures-location-logo-tour-operateur-tourisme-vacances-client.png';

    var row = table.insertRow();
    row.innerHTML = `
      <td class="text-center"><span style="font-size: 14px;">${startIndex + index + 1}</span></td>
      <td>
        <div style="display: flex; align-items: center;">
          <img src="${userImage}" alt="ImageUsers" width="30" style="margin-right: 10px;">
          <div style="font-size: 14px;">
            <span>üôã‡∏ä‡∏∑‡πà‡∏≠: ${rowIndex[4]}</span><br>
            <span>‡∏ù‡πà‡∏≤‡∏¢: ${rowIndex[6]}</span><br>
            <span>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${rowIndex[5]}</span><br>
            <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${rowIndex[2]}</span>
          </div>
        </div>
      </td>
      <td>
        <div style="display: flex; align-items: center;">
          <img src="${carImage}" alt="ImageUsers" width="30" style="margin-right: 10px;">
          <div style="font-size: 14px;">
            <span>${status}</span><br>
            <span>KeyCar: ${rowIndex[11]}</span><br>
            <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${rowIndex[12]}</span><br>
            <span>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ: ${rowIndex[13]}</span>
          </div>
        </div>
      </td>
      <td>
        <span style="font-size: 14px;">üèùÔ∏è‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: ${rowIndex[10]}</span><br>
        <span style="font-size: 14px;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${rowIndex[8]}</span><br>
        <span style="font-size: 14px;">‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà: ${rowIndex[9]}</span>
      </td>
      <td>
        <span style="font-size: 14px;">üóìÔ∏è‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: ${rowIndex[15]}</span><br>
        <span style="font-size: 14px;">üóìÔ∏è‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${rowIndex[16]}</span><br>
      </td>
      <td class="text-center">${pdfButton}</td>
      <td class="text-center">${actionStatus}</td>
    `;
  });
}

const renderPageCars = (totalItems) => {
  const totalPages = Math.ceil(totalItems / itemsPerCars);
  const paginationContainer = document.getElementById('paginationCars');
  paginationContainer.innerHTML = '';
  if (totalPages > 1) {
    const createPageButton = (text, page, isDisabled = false, isActive = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
      const button = document.createElement('button');
      button.className = 'page-link';
      button.innerText = text;
      button.onclick = () => {
        if (!isDisabled) {
          currentCars = page;
          renderCars(filteredCars);
          renderPageCars(totalItems);
        }
      };
      li.appendChild(button);
      return li;
    };
    paginationContainer.appendChild(createPageButton('‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö', currentCars - 1, currentCars === 1));

    if (currentCars > 2) {
      paginationContainer.appendChild(createPageButton(1, 1, false, currentCars === 1));
      if (currentCars > 3) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
    }
    paginationContainer.appendChild(createPageButton(currentCars, currentCars, false, true));

    if (currentCars < totalPages - 1) {
      if (currentCars < totalPages - 2) {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'page-item disabled';
        ellipsis.innerHTML = '<span class="page-link">...</span>';
        paginationContainer.appendChild(ellipsis);
      }
      paginationContainer.appendChild(createPageButton(totalPages, totalPages, false, currentCars === totalPages));
    }
    paginationContainer.appendChild(createPageButton('‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', currentCars + 1, currentCars === totalPages));
  }
}

const filterCars = () => {
  const query = document.getElementById('searchCars').value.toLowerCase();
  filteredCars = dataCars.filter(row => {
    return row.some(column => column.toLowerCase().includes(query));
  });

  currentCars = 1;
  renderCars(filteredCars);
  renderPageCars(filteredCars.length);
}

const filterCarsStatus = (status) => {
  const userRole = localStorage.getItem('level') || '';
  if ((userRole !== 'SuperAdmin' && userRole !== 'Admin') && (status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' || status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) {
    createToast("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ", 3);
    return;
  }

  filterPageCars = status;
  filteredCars = status ? dataCars.filter(item => item[1] === status) : dataCars;
  currentCars = 1;
  renderCars(filteredCars);
  renderPageCars(filteredCars.length);
}

const countsStatusCars = (data) => {
  const countsStatusCarsA = data.filter(row => row[1] === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö").length;
  const countsStatusCarsB = data.filter(row => row[1] === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å").length;
  const countsStatusCarsC = data.filter(row => row[1] === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥").length;
  const countsStatusCarsD = data.filter(row => row[1] === "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥").length;
  document.getElementById('countsStatusCarsA').innerText = countsStatusCarsA;
  document.getElementById('countsStatusCarsB').innerText = countsStatusCarsB;
  document.getElementById('countsStatusCarsC').innerText = countsStatusCarsC;
  document.getElementById('countsStatusCarsD').innerText = countsStatusCarsD;
}

let calendarCars = null;
const showcalendarCars = () => {
  if (calendarCars) {
    google.script.run.withSuccessHandler(function(data) {
      calendarCars.removeAllEvents();
      calendarCars.addEventSource(data);
    }).getCalendarCars();
  } else {
    google.script.run.withSuccessHandler(function(data) {
      let calendarEl = document.getElementById('calendarCars');
      
      calendarCars = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        nowIndicator: true,
        headerToolbar: {
          left: 'prev,next today dayGridMonth',
          center: '',
          right: 'title'
        },
        navLinks: true, 
        editable: false,
        droppable: false,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        locale: 'th',
        buttonText: {
          today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
          month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
          week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
          day: '‡∏ß‡∏±‡∏ô',
          list: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£',  
        },
        events: data, 
        eventClick: function(info) {
          detailCarsCalendar(info.event.extendedProps.idevent);
        },
        eventDidMount: function(info) {
          let status = info.event.extendedProps.status;
          let backgroundColor;

          switch(status) {
            case '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':
              backgroundColor = 'var(--box2)';
              break;
            case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':
              backgroundColor = 'var(--box3)';
              break;
            case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å':
              backgroundColor = 'var(--box4)';
              break;
            default:
              backgroundColor = 'var(--box2)';
          }

          if (info.el) {
            info.el.style.backgroundColor = backgroundColor;
            info.el.style.color = 'var(--bs-white)';

            const startDate = new Date(info.event.start);
            const endDate = new Date(info.event.end);
            const formattedStartDate = formatThaiDateTime(startDate);
            const formattedEndDate = formatThaiDateTime(endDate);

            let tooltipContent = `
              <strong>üÜî</strong><small>${info.event.extendedProps.idevent}</small><br>
              <strong>üìù</strong><small>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ : ${info.event.extendedProps.status}</small>
              <strong>üìù</strong><small>UID : ${info.event.extendedProps.uid}  ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á : ${info.event.extendedProps.name}</small>
              <strong>üìù</strong><small>‡∏ù‡πà‡∏≤‡∏¢ : ${info.event.extendedProps.group} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô : ${info.event.extendedProps.dpm}</small><br>
              <strong>üöó</strong><small>‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤ : ${info.event.extendedProps.cars4} ${info.event.extendedProps.cars5} ${info.event.extendedProps.cars6}</small><br>
              <strong>üèùÔ∏è</strong><small>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• : ${info.event.extendedProps.cars3} ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô : ${info.event.extendedProps.cars1} ‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà : ${info.event.extendedProps.cars2}</small><br>
              <strong>üìÖ</strong><small>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà : ${formattedStartDate} ‡∏ñ‡∏∂‡∏á : ${formattedEndDate}</small><br>
            `;
            info.el.setAttribute('data-bs-toggle', 'tooltip');
            info.el.setAttribute('data-bs-html', 'true');
            info.el.setAttribute('title', tooltipContent);
            info.el.setAttribute('data-bs-custom-class', 'custom-tooltip');

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            info.el.addEventListener('mouseover', function() {
              info.el.style.backgroundColor = 'var(--box1)';
              info.el.style.transform = 'scale(1.1)';
            });
            info.el.addEventListener('mouseout', function() {
              info.el.style.backgroundColor = backgroundColor;
              info.el.style.transform = 'scale(1)';
            });
          }
        },
        eventContent: function(info) {
          let cars6 = info.event.extendedProps.cars6 || '';
          return {
            html: `<strong>üìù</strong><small> ${cars6}</small>`
          };
        },
      });
      calendarCars.render();
    }).getCalendarCars();
  }
}

const detailCarsCalendar = (codeID) => {
  const userRole1 = localStorage.getItem('fullname') || '';
  const userRole2 = localStorage.getItem('level') || '';
  const dataAllCars = dataCars.filter(r => r[0] == codeID);
    if ((userRole2 !== 'SuperAdmin' && userRole2 !== 'Admin' && userRole1 !== dataAllCars[4])) {
      createToast("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", 3);
      return;
    }
  const startDate = new Date(dataAllCars[0][15]);
  const endDate = new Date(dataAllCars[0][16]);
  $("#detailCarsStar").html(formatThaiDateTime(startDate));  
  $("#detailCarsEnd").html(formatThaiDateTime(endDate)); 

  $('#fullCarsCalendaModal').modal('show');
  $("#detailCars0").html(dataAllCars[0][0]);

  let status = '';

  if (dataAllCars[0][1] === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö") {
    status = "<span style='color: var(--box3);font-size: 14px;'>‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>";
  } else if (dataAllCars[0][1] === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"){
    status = "<span style='color: var(--box2);font-size: 14px;'>‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>";
  } else if (dataAllCars[0][1] === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") {
    status = "<span style='color: var(--box4);font-size: 14px;'>‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>";
  }

  $("#detailCars1").html(status);
  $("#detailCars2").html(dataAllCars[0][2]);
  $("#detailCars3").html(dataAllCars[0][3]);
  $("#detailCars4").html(dataAllCars[0][4]);
  $("#detailCars5").html(dataAllCars[0][5]);
  $("#detailCars6").html(dataAllCars[0][6]);
  $("#detailCars7").html(dataAllCars[0][8]);
  $("#detailCars8").html(dataAllCars[0][9]);
  $("#detailCars9").html(dataAllCars[0][10]);
}

const showModalCars = (codeID) => {
  const userRole = localStorage.getItem('level') || '';
  if ((userRole !== 'SuperAdmin' && userRole !== 'Admin')) {
    createToast("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", 3);
    return;
  }
  const row = dataCars.find(row => row[0] === codeID);
  $('#ApproveCarsModal').modal('show');
  selectedCars = row;
  if (row) {
    $('#approveDataCars1').val(row[1]);
    $('#approveDataCars2').val(row[14]);
    const startDate = new Date(row[15]);
    const endDate = new Date(row[16]);
    const modalContent = `
      <div style="font-size: 16px;"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${row[2]}</div>
      <div style="font-size: 16px;"><strong>UID:</strong> ${row[3]} <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ:</strong> ${row[4]}</div>
      <div style="font-size: 16px;"><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${row[5]} <strong>‡∏ù‡πà‡∏≤‡∏¢:</strong> ${row[6]}</div>
      <div style="font-size: 16px;"><strong>‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤:</strong> ${row[11]} ${row[12]} ${row[13]}</div>
      <div style="font-size: 16px;"><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤:</strong> ${row[10]} <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ñ:</strong> ${row[8]} ${row[9]}</div>
      <div style="font-size: 16px;"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${row[2]}</div>
      <div style="font-size: 16px;"><strong>‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</strong> ${formatThaiDateTime(startDate)}</div>
      <div style="font-size: 16px;"><strong>‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ${formatThaiDateTime(endDate)}</div>
      
    `;
    document.getElementById('APDataCars').innerHTML = modalContent;
  }
}

let dataDriver = [];
const openSearchDriverModal = () => {
  $('#ApproveCarsModal').modal('hide');
  google.script.run.withSuccessHandler((data) => {
    dataDriver = data;
    filterDriver();
  }).getDataUsers();
  $('#searchDriverModal').modal('show');
}

const closeSearchDriverModal = () => {
  $('#searchDriverModal').modal('hide');
  $('#ApproveCarsModal').modal('show');
}

const filterDriver = () => {
  const searchValue = document.getElementById('searchDriver').value.toLowerCase();
  const filteredDrivers = dataDriver.filter(user => user[6] === 'Driver' && user[3].toLowerCase().includes(searchValue));
  const tableBody = document.getElementById('TableDriverBody');
  tableBody.innerHTML = '';

  if (filteredDrivers.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan='7' class='fw-bold text-danger text-center p-4'>
          <i class='fa-solid fa-circle-info text-danger'></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! üòì
        </td>
      </tr>
    `;
    return;
  }
  filteredDrivers.forEach((user, index) => {
    const row = `
      <tr>
        <td class="text-center"><span style="font-size: 14px;">${index + 1}</span></td>
        <td class="text-center"><img src="${user[7]}" width="30" height="30" alt="${user[3]}"></td>
        <td class="text-center"><span style="font-size: 14px;">${user[0]}</span></td>
        <td class="text-center"><span style="font-size: 14px;">${user[3]}</span></td>
        <td class="text-center"><span style="font-size: 14px;">${user[5]}</span></td>
        <td class="text-center"><span style="font-size: 14px;">${user[6]}</span></td>
        <td class="text-center">
          <button class="btn set-button btn-sm" onclick="selectDriver('${user[3]}')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </td>
      </tr>
    `;
    tableBody.insertAdjacentHTML('beforeend', row);
  });
}

const selectDriver = (driverName) => {
  document.getElementById('approveDataCars2').value = driverName;
  closeSearchDriverModal();
};

const submitAPCars = () => {
  const carsdata1 = document.getElementById('approveDataCars1').value;
  const carsdata2 = document.getElementById('approveDataCars2').value;
  const carsdataname = document.getElementById('user-show1').innerText;
  const carsdatasig = document.getElementById('user-show4').innerText;
  if (!carsdata1) {
    createToast("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 0);
    return;
  }
  const data = {
    codeID: selectedCars[0],
    carsdataname: carsdataname,
    carsdatasig: carsdatasig,
    carsdata1: carsdata1,
    carsdata2: carsdata2
  };
  $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin" });
  google.script.run.withSuccessHandler((res) => {
  $.LoadingOverlay("hide");
    $('#ApproveCarsModal').modal('hide');
    createToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 1);
    insertDataCars(filterPageCars);
    closeAPCars();
  }).addAPDataCars(data);
}

const closeAPCars = () => {
  document.getElementById('approveDataCars1').value = '';
  document.getElementById('approveDataCars2').value = '';
}

const formatThaiDateTime = (date) => {
  const thaiMonths = [
      '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
      '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
      '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
      '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
      '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
      '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
      '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
      '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
      '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
      '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
      '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];

  const thaiMonth = thaiMonths[date.getMonth()];
  const thaiYear = date.getFullYear() + 543; 
  const thaiDate = `${date.getDate()} ${thaiMonth} ${thaiYear}`;
  const thaiTime = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
  return `${thaiDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${thaiTime} ‡∏ô.`;
}


if (!window.calendar_languages) {
    window.calendar_languages = {};
  }

window.calendar_languages['th-TH'] = {
  error_noview: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö View {0}',
  error_dateformat: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á {0}. ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ "now" ‡∏´‡∏£‡∏∑‡∏≠ "yyyy-mm-dd"',
  error_loadurl: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ',
  error_where: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î {0}. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡πà‡∏≤ "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
  error_timedevide: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô:  Time split parameter ‡∏Ñ‡∏ß‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏≤‡∏£ 60 ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô. ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πà‡∏ô 10, 15, 30',
  
  no_events_in_day: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏î‡πÜ',
  
  title_year: '{0}',
  title_month: '{0} {1}',
  title_week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà {0} ‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ {1}',
  title_day: '{0} {1} {2}, {3}',
  
  week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà {0}',
  all_day: '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
  time: '‡πÄ‡∏ß‡∏•‡∏≤',
  events: '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
  before_time: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô Timeline',
  after_time: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á Timeline',
  
  m0: '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
  m1: '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
  m2: '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
  m3: '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
  m4: '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
  m5: '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
  m6: '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
  m7: '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
  m8: '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
  m9: '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
  m10: '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
  m11: '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°',
  
  ms0: '‡∏°.‡∏Ñ.',
  ms1: '‡∏Å.‡∏û.',
  ms2: '‡∏°‡∏µ.‡∏Ñ.',
  ms3: '‡πÄ‡∏°.‡∏¢.',
  ms4: '‡∏û.‡∏Ñ.',
  ms5: '‡∏°‡∏¥.‡∏¢.',
  ms6: '‡∏Å.‡∏Ñ.',
  ms7: '‡∏™.‡∏Ñ.',
  ms8: '‡∏Å.‡∏¢.',
  ms9: '‡∏ï.‡∏Ñ.',
  ms10: '‡∏û.‡∏¢.',
  ms11: '‡∏ò.‡∏Ñ.',
  
  d0: '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
  d1: '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',
  d2: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',
  d3: '‡∏û‡∏∏‡∏ò',
  d4: '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',
  d5: '‡∏®‡∏∏‡∏Å‡∏£‡πå',
  d6: '‡πÄ‡∏™‡∏≤‡∏£‡πå',
  
  first_day: 1,
  week_numbers_iso_8601: true,
  holidays: {
  }
};
</script>
